#    rpmsigdig.at: rpm signature and digest tests

AT_BANNER([RPM signatures and digests])

# ------------------------------
# Test pre-built package verification
AT_SETUP([rpmkeys -Kv <unsigned> 1])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

runroot rpmkeys -Kv /data/RPMS/hello-2.0-1.x86_64.rpm /data/RPMS/hello-1.0-1.i386.rpm
],
[0],
[/data/RPMS/hello-2.0-1.x86_64.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    MD5 digest: OK
/data/RPMS/hello-1.0-1.i386.rpm:
    Header SHA1 digest: OK
    MD5 digest: OK
],
[])
AT_CLEANUP

# ------------------------------
# Test rpmkeys write errors
AT_SETUP([[rpmkeys -K no space left on stdout]])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT[

runroot rpmkeys -Kv /data/RPMS/hello-2.0-1.x86_64.rpm /data/RPMS/hello-1.0-1.i386.rpm >/dev/full
]],255,,[[Error writing to log: No space left on device
]])
AT_CLEANUP


AT_SETUP([rpmkeys -Kv <reconstructed> 1])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

cp "${RPMTEST}"/data/misc/hello.intro "${RPMTEST}"/data/misc/hello.payload .
gzip -cd < hello.payload > hello.uc-payload
cat hello.intro hello.payload > "${RPMTEST}"/tmp/hello-c.rpm
cat hello.intro hello.uc-payload > "${RPMTEST}"/tmp/hello-uc.rpm
runroot rpmkeys -Kv /tmp/hello-c.rpm /tmp/hello-uc.rpm
],
[1],
[/tmp/hello-c.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    MD5 digest: OK
/tmp/hello-uc.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 ALT digest: OK
    MD5 digest: BAD (Expected 055607c4dee6464b9415ae726e7d81a7 != 839d24c30e5188e0b83599fbe3865919)
],
[])
AT_CLEANUP

# ------------------------------
# Test corrupted package verification (corrupted signature)
AT_SETUP([rpmkeys -Kv <corrupted unsigned> 1])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
# conv=notrunc bs=1 seek=261 count=6 2> /dev/null
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=333 count=4 2> /dev/null
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    MD5 digest: BAD (Expected 007ca1d8b35cca02a1854ba301c5432e != 137ca1d8b35cca02a1854ba301c5432e)
],
[])
AT_CLEANUP
# ------------------------------
# Test corrupted package verification (corrupted header)
AT_SETUP([rpmkeys -Kv <corrupted unsigned> 2])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=5555 count=6 2> /dev/null
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64.rpm:
    Header SHA256 digest: BAD (Expected ef920781af3bf072ae9888eec3de1c589143101dff9cc0b561468d395fb766d9 != 29fdfe92782fb0470a9a164a6c94af87d3b138c63b39d4c30e0223ca1202ba82)
    Header SHA1 digest: BAD (Expected 5cd9874c510b67b44483f9e382a1649ef7743bac != 4261b2c1eb861a4152c2239bce20bfbcaa8971ba)
    Payload SHA256 digest: OK
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != de65519eeb4ab52eb076ec054d42e34e)
],
[])
AT_CLEANUP

# ------------------------------
# Test corrupted package verification (corrupted payload)
AT_SETUP([rpmkeys -Kv <corrupted unsigned> 3])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=7777 count=6 2> /dev/null
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: BAD (Expected 84a7338287bf19715c4eed0243f5cdb447eeb0ade37b2af718d4060aefca2f7c != bea903609dceac36e1f26a983c493c98064d320fdfeb423034ed63d649b2c8dc)
    Payload SHA256 ALT digest: NOTFOUND
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != d662cd0d81601a7107312684ad1ddf38)
],
[])
AT_CLEANUP

# ------------------------------
# Test corrupted package verification (corrupted header)
AT_SETUP([rpmkeys -Kv <corrupted unsigned> 4])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=4750 count=4 2> /dev/null
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64.rpm:
],
[error: /tmp/hello-2.0-1.x86_64.rpm: tag[[13]]: BAD, tag 1028 type 0 offset 116 count 5 len 7]
)
AT_CLEANUP
# ------------------------------
# Reproducably build and verify a package
AT_SETUP([rpmkeys -Kv <unsigned> 2])
AT_KEYWORDS([rpmkeys digest])
AT_CHECK([
RPMDB_INIT

runroot rpmbuild -bb --quiet \
	--define "%optflags -O2 -g" \
	--define "%_target_platform noarch-linux" \
	--define "%_binary_payload w.ufdio" \
	--define "%_buildhost localhost" \
	--define "%use_source_date_epoch_as_buildtime 1" \
	--define "%source_date_epoch_from_changelog 1" \
	--define "%clamp_mtime_to_source_date_epoch 1" \
	/data/SPECS/attrtest.spec 
for v in SHA256HEADER SHA1HEADER SIGMD5 PAYLOADDIGEST PAYLOADDIGESTALT; do
    runroot rpm -q --qf "${v}: %{${v}}\n" /build/RPMS/noarch/attrtest-1.0-1.noarch.rpm
done
runroot rpmkeys -Kv /build/RPMS/noarch/attrtest-1.0-1.noarch.rpm
],
[0],
[SHA256HEADER: 96247e5195c243b4d0841bea3ce0b27bb117ab792d2d32886be664c08766ae07
SHA1HEADER: abec4e271b086b434445b4ab82458afe271e77f4
SIGMD5: 03fad245ae85849b636ac6e3eb883af9
PAYLOADDIGEST: ba951e9327654ed94e5261315ef8a74269ccf7ae93412ce9627d02e34247f9bc
PAYLOADDIGESTALT: ba951e9327654ed94e5261315ef8a74269ccf7ae93412ce9627d02e34247f9bc
/build/RPMS/noarch/attrtest-1.0-1.noarch.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 ALT digest: OK
    Payload SHA256 digest: OK
    MD5 digest: OK
],
[])
AT_CLEANUP

# ------------------------------
# Import a public RSA key
AT_SETUP([rpmkeys --import rsa (rpmdb)])
AT_KEYWORDS([rpmkeys import])
AT_CHECK([
RPMDB_INIT

runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpm -qi gpg-pubkey-1964c5fc-58e63918|grep -v Date|grep -v Version:
runroot rpm -q --provides gpg-pubkey-1964c5fc-58e63918
],
[0],
[Name        : gpg-pubkey
Version     : 1964c5fc
Release     : 58e63918
Architecture: (none)
Group       : Public Keys
Size        : 0
License     : pubkey
Signature   : (none)
Source RPM  : (none)
Build Host  : localhost
Packager    : rpm.org RSA testkey <rsa@rpm.org>
Summary     : rpm.org RSA testkey <rsa@rpm.org> public key
Description :
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBFjmORgBCAC7TMEk6wnjSs8Dr4yqSScWdU2pjcqrkTxuzdWvowcIUPZI0w/g
HkRqGd4apjvY2V15kjL10gk3QhFP3pZ/9p7zh8o8NHX7aGdSGDK7NOq1eFaErPRY
91LW9RiZ0lbOjXEzIL0KHxUiTQEmdXJT43DJMFPyW9fkCWg0OltiX618FUdWWfI8
eySdLur1utnqBvdEbCUvWK2RX3vQZQdvEBODnNk2pxqTyV0w6VPQ96W++lF/5Aas
7rUv3HIyIXxIggc8FRrnH+y9XvvHDonhTIlGnYZN4ubm9i4y3gOkrZlGTrEw7elQ
1QeMyG2QQEbze8YjpTm4iLABCBrRfPRaQpwrABEBAAG0IXJwbS5vcmcgUlNBIHRl
c3RrZXkgPHJzYUBycG0ub3JnPokBNwQTAQgAIQUCWOY5GAIbAwULCQgHAgYVCAkK
CwIEFgIDAQIeAQIXgAAKCRBDRFkeGWTF/MxxCACnjqFL+MmPh9W9JQKT2DcLbBzf
Cqo6wcEBoCOcwgRSk8dSikhARoteoa55JRJhuMyeKhhEAogE9HRmCPFdjezFTwgB
BDVBpO2dZ023mLXDVCYX3S8pShOgCP6Tn4wqCnYeAdLcGg106N4xcmgtcssJE+Pr
XzTZksbZsrTVEmL/Ym+R5w5jBfFnGk7Yw7ndwfQsfNXQb5AZynClFxnX546lcyZX
fEx3/e6ezw57WNOUK6WT+8b+EGovPkbetK/rGxNXuWaP6X4A/QUm8O98nCuHYFQq
+mvNdsCBqGf7mhaRGtpHk/JgCn5rFvArMDqLVrR9hX0LdCSsH7EGE+bR3r7wuQEN
BFjmORgBCACk+vDZrIXQuFXEYToZVwb2attzbbJJCqD71vmZTLsW0QxuPKRgbcYY
zp4K4lVBnHhFrF8MOUOxJ7kQWIJZMZFt+BDcptCYurbD2H4W2xvnWViiC+LzCMzz
iMJT6165uefL4JHTDPxC2fFiM9yrc72LmylJNkM/vepT128J5Qv0gRUaQbHiQuS6
Dm/+WRnUfx3i89SV4mnBxb/Ta93GVqoOciWwzWSnwEnWYAvOb95JL4U7c5J5f/+c
KnQDHsW7sIiIdscsWzvgf6qs2Ra1Zrt7Fdk4+ZS2f/adagLhDO1C24sXf5XfMk5m
L0OGwZSr9m5s17VXxfspgU5ugc8kBJfzABEBAAGJAR8EGAEIAAkFAljmORgCGwwA
CgkQQ0RZHhlkxfzwDQf/Y5on5o+s/xD3tDyRYa6SErfT44lEArdCD7Yi+cygJFox
3jyM8ovtJAkwRegwyxcaLN7zeG1p1Sk9ZAYWQEJT6qSU4Ppu+CVGHgxgnTcfUiu6
EZZQE6srvua53IMY1lT50M7vx0T5VicHFRWBFV2C/Mc32p7cEE6nn45nEZgUXQNl
ySEyvoRlsAJq6gFsfqucVz2vMJDTMVczUtq1CjvUqFbif8JVL36EoZCf1SeRw6d6
s1Kp3AA33Rjd+Uw87HJ4EIB75zMFQX2H0ggAVdYTQcqGXHP5MZK1jJrHfxJyMi3d
UNW2iqnN3BA7guhOv6OMiROF1+I7Q5nWT63mQC7IgQ==
=Z6nu
-----END PGP PUBLIC KEY BLOCK-----

gpg(rpm.org RSA testkey <rsa@rpm.org>) = 4:4344591e1964c5fc-58e63918
gpg(1964c5fc) = 4:4344591e1964c5fc-58e63918
gpg(4344591e1964c5fc) = 4:4344591e1964c5fc-58e63918
],
[])
AT_CLEANUP

AT_SETUP([rpmkeys --import rsa (fs)])
AT_KEYWORDS([rpmkeys import])
AT_CHECK([
RPMDB_INIT

runroot_other mkdir -p /tmp/kr
runroot rpmkeys \
	--define "_keyringpath /tmp/kr" \
	--define "_keyring fs" \
	--import /data/keys/rpm.org-rsa-2048-test.pub
runroot_other cat /tmp/kr/gpg-pubkey-1964c5fc-58e63918.key | grep -v 'Version: '
],
[0],
[-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBFjmORgBCAC7TMEk6wnjSs8Dr4yqSScWdU2pjcqrkTxuzdWvowcIUPZI0w/g
HkRqGd4apjvY2V15kjL10gk3QhFP3pZ/9p7zh8o8NHX7aGdSGDK7NOq1eFaErPRY
91LW9RiZ0lbOjXEzIL0KHxUiTQEmdXJT43DJMFPyW9fkCWg0OltiX618FUdWWfI8
eySdLur1utnqBvdEbCUvWK2RX3vQZQdvEBODnNk2pxqTyV0w6VPQ96W++lF/5Aas
7rUv3HIyIXxIggc8FRrnH+y9XvvHDonhTIlGnYZN4ubm9i4y3gOkrZlGTrEw7elQ
1QeMyG2QQEbze8YjpTm4iLABCBrRfPRaQpwrABEBAAG0IXJwbS5vcmcgUlNBIHRl
c3RrZXkgPHJzYUBycG0ub3JnPokBNwQTAQgAIQUCWOY5GAIbAwULCQgHAgYVCAkK
CwIEFgIDAQIeAQIXgAAKCRBDRFkeGWTF/MxxCACnjqFL+MmPh9W9JQKT2DcLbBzf
Cqo6wcEBoCOcwgRSk8dSikhARoteoa55JRJhuMyeKhhEAogE9HRmCPFdjezFTwgB
BDVBpO2dZ023mLXDVCYX3S8pShOgCP6Tn4wqCnYeAdLcGg106N4xcmgtcssJE+Pr
XzTZksbZsrTVEmL/Ym+R5w5jBfFnGk7Yw7ndwfQsfNXQb5AZynClFxnX546lcyZX
fEx3/e6ezw57WNOUK6WT+8b+EGovPkbetK/rGxNXuWaP6X4A/QUm8O98nCuHYFQq
+mvNdsCBqGf7mhaRGtpHk/JgCn5rFvArMDqLVrR9hX0LdCSsH7EGE+bR3r7wuQEN
BFjmORgBCACk+vDZrIXQuFXEYToZVwb2attzbbJJCqD71vmZTLsW0QxuPKRgbcYY
zp4K4lVBnHhFrF8MOUOxJ7kQWIJZMZFt+BDcptCYurbD2H4W2xvnWViiC+LzCMzz
iMJT6165uefL4JHTDPxC2fFiM9yrc72LmylJNkM/vepT128J5Qv0gRUaQbHiQuS6
Dm/+WRnUfx3i89SV4mnBxb/Ta93GVqoOciWwzWSnwEnWYAvOb95JL4U7c5J5f/+c
KnQDHsW7sIiIdscsWzvgf6qs2Ra1Zrt7Fdk4+ZS2f/adagLhDO1C24sXf5XfMk5m
L0OGwZSr9m5s17VXxfspgU5ugc8kBJfzABEBAAGJAR8EGAEIAAkFAljmORgCGwwA
CgkQQ0RZHhlkxfzwDQf/Y5on5o+s/xD3tDyRYa6SErfT44lEArdCD7Yi+cygJFox
3jyM8ovtJAkwRegwyxcaLN7zeG1p1Sk9ZAYWQEJT6qSU4Ppu+CVGHgxgnTcfUiu6
EZZQE6srvua53IMY1lT50M7vx0T5VicHFRWBFV2C/Mc32p7cEE6nn45nEZgUXQNl
ySEyvoRlsAJq6gFsfqucVz2vMJDTMVczUtq1CjvUqFbif8JVL36EoZCf1SeRw6d6
s1Kp3AA33Rjd+Uw87HJ4EIB75zMFQX2H0ggAVdYTQcqGXHP5MZK1jJrHfxJyMi3d
UNW2iqnN3BA7guhOv6OMiROF1+I7Q5nWT63mQC7IgQ==
=Z6nu
-----END PGP PUBLIC KEY BLOCK-----
],
[])
AT_CLEANUP

# -----------------------------------------
# Import a public Ed25519 key with a subkey
AT_SETUP([rpmkeys --import ed25519 with good and revoked subkeys 1])
AT_KEYWORDS([rpmkeys import])
RPMDB_INIT
AT_CHECK([
runroot rpmkeys --import /data/keys/rpm.org-ed25519-subkey-test.pub
runroot rpm -qi gpg-pubkey-a0e0c1c7-623f6177|grep -v Date|grep -v Version:
runroot rpm -q --provides gpg-pubkey
],
[0],
[[Name        : gpg-pubkey
Version     : a0e0c1c7
Release     : 623f6177
Architecture: (none)
Group       : Public Keys
Size        : 0
License     : pubkey
Signature   : (none)
Source RPM  : (none)
Build Host  : localhost
Packager    : test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org>
Summary     : test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org> public key
Description :
-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYj9egBYJKwYBBAHaRw8BAQdAqeaD3Smr6MJd1fzczVHdNcVnpGNO6fXPQ1W3
Bir40C60eXRlc3QgcnBtLm9yZyBlZDI1NTE5IGtleSB3aXRoIHZhbGlkIHNpZ25p
bmcgYW5kIGVuY3J5cHRpb24gc3Via2V5cyBhbmQgYSByZXZva2VkIHNpZ25pbmcg
c3Via2V5IDxjb21wbGV4LWVkMjU1MTlAcnBtLm9yZz6ImgQTFgoAQhYhBHsyy8MN
NCMWJzLdhZ3W8Dmg4MHHBQJiP2F3AhsDBQkDwmcABQsJCAcCAyICAQYVCgkICwIE
FgIDAQIeBwIXgAAKCRCd1vA5oODBx1y0AQCC14V8ULAoBdQsoanET2beUJgkIdT6
LBdncZx8loRLiAD+LEWLpAGBMEq+iblPTAHjApsik02eDawLdl66Yi69Xgi4OARi
P16AEgorBgEEAZdVAQUBAQdAeHhEFfY5qU6cpSMQ/LgzayG+8Q/VBbO5X8B3R433
zi4DAQgHiHgEGBYKACAWIQR7MsvDDTQjFicy3YWd1vA5oODBxwUCYj9egAIbDAAK
CRCd1vA5oODBx6lSAP9l0egUO0D64YP3PtIdVL7UFVjwwvWUFrqj/xHwtDNPDQD/
SHbV968XVh/qsvcijlmzkh+cKZHZU7yq+bQwADL/LAa4MwRiP16eFgkrBgEEAdpH
DwEBB0CKijfLm9FInM+RO1MqJ7HVqAlPQRM7MI9NRj0Et135eYjvBBgWCgAgFiEE
ezLLww00IxYnMt2FndbwOaDgwccFAmI/Xp4CGwIAgQkQndbwOaDgwcd2IAQZFgoA
HRYhBAG2T6OMvAxOce/Unqns8lz1dXJHBQJiP16eAAoJEKns8lz1dXJHcoABAL+8
SzJ5ZIftWyeWNa/9r6dPezIiT62ke4cUs/nzJRUzAQDodq0SpWejSG6TgEBlR6Lc
Qd+Kd0izRTtcb03QyLQ+C6pDAP9ZxoPqlnye/DY3OhNd1Uxq5JbyK0ve15xi3IZl
SYl8FQEAmJdVsMh5XfkTw49/5jkXAda12fbKPgbgz0GF8U5p2Q+4MwRiP162Fgkr
BgEEAdpHDwEBB0DDdx/EVOQCjzXEKclTQNhMu523Dt100GaWCpr45bdCOYiUBCgW
CgA8FiEEezLLww00IxYnMt2FndbwOaDgwccFAmI/Xu0eHQNUZXN0IFJQTSByZXZv
Y2F0aW9uIGhhbmRsaW5nAAoJEJ3W8Dmg4MHHEM4BAKX6AI5rihJAo4ztUv7KhgiD
/L6l/fd5EfnEH+Fd9hpdAQCMuaht54q09kFxQw2S52mA7D9Ka7fuExyp3pAyHyap
D4jvBBgWCgAgFiEEezLLww00IxYnMt2FndbwOaDgwccFAmI/XrYCGwIAgQkQndbw
OaDgwcd2IAQZFgoAHRYhBE7ao2AiDuxZOQu+Ntv4gI97qxB6BQJiP162AAoJENv4
gI97qxB6Lm0A/ilFgqZC8s1b0LsxROrhNr/ZTRPL5uUPHxPe1m6LkpbzAQCWA2wc
3YC6ysipXUH7YykeHPQa7CMT+D4blywQFqITBjKcAP99Xo0dx06PrT4scOU4W1GE
2O7VCEoDq2K4M2AfZJjx6QEAl6n2BYN9Z9ZAOQxokkVhTTgudIKgV0Ro+CdY7YB+
RAK5AY0EYj9faQEMAK/LykZKhjMBtVWQur3hi++FKDbwthKDjQb9KsI0GTKbpAoz
I4G6b21dBiR0MCuDPNS9Hwb+k5leb43DSlnYgDgzrWNK6hkcNewjc/u6a+rjOeQK
Xqun93heWdMxucLhj0SJ8fOwP0PEpicmeG+fsuet8qduzRvFv7R5YqHFJd5HAMWD
gfDilA0PuhynbWNUaUVEWYaX1F1F78YQ5lIPrgKsJp+Roy2dRatUcXcgzavUm2mv
0YpQsmLBMkFlswgxxO4wsfPP3MM5XjNuLMtPzM8C9VU9qYr9EDbZjR6JJWxF99Ti
PeWOvS+4R6CgFZzhoApkHLN0Ie69jN+pCu7jpbnfEzZ9O8QnGZLjjpLbVH6fXFZk
tcssOIMX8JWo08/p1SAr9FXfzG1ic3l7Xpu0wCYguZBJlxBKQk9kvgWnn0vtceds
XhekwwtCGy2wdndlRUHivo8SoueV36i142NAFSYgpn67Np+l831EVAOgku5K11/j
JLd87Oo3G17O+sfXDQARAQABiHgEGBYKACAWIQR7MsvDDTQjFicy3YWd1vA5oODB
xwUCYj9faQIbDAAKCRCd1vA5oODBx7HQAP4rUUQfq7Qj3N8MZD8rHJ0BhbNpIsNL
gxvlun/SVujaIQEAzRzB5/I+V64FFvVZs4iFYJbvwpXGpiZs6aXxRBaOFw8=
=rm2D
-----END PGP PUBLIC KEY BLOCK-----

gpg(test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org>) = 4:9dd6f039a0e0c1c7-623f6177
gpg(a0e0c1c7) = 4:9dd6f039a0e0c1c7-623f6177
gpg(9dd6f039a0e0c1c7) = 4:9dd6f039a0e0c1c7-623f6177
gpg(f5757247) = 4:a9ecf25cf5757247-623f5e9e
gpg(a9ecf25cf5757247) = 4:a9ecf25cf5757247-623f5e9e
]],
[])
AT_CLEANUP

AT_SETUP([rpmkeys --import ed25519 with good and revoked subkeys 2])
AT_KEYWORDS([rpmkeys import])
RPMDB_INIT
AT_CHECK([
runroot rpmkeys --import /data/keys/rpm.org-ed25519-subkey-2-test.pub
runroot rpm -qi gpg-pubkey-a0e0c1c7-623f6177|grep -v Date|grep -v Version:
runroot rpm -q --provides gpg-pubkey
runroot rpm -e gpg-pubkey
],
[0],
[[Name        : gpg-pubkey
Version     : a0e0c1c7
Release     : 623f6177
Architecture: (none)
Group       : Public Keys
Size        : 0
License     : pubkey
Signature   : (none)
Source RPM  : (none)
Build Host  : localhost
Packager    : test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org>
Summary     : test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org> public key
Description :
-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYj9egBYJKwYBBAHaRw8BAQdAqeaD3Smr6MJd1fzczVHdNcVnpGNO6fXPQ1W3
Bir40C60eXRlc3QgcnBtLm9yZyBlZDI1NTE5IGtleSB3aXRoIHZhbGlkIHNpZ25p
bmcgYW5kIGVuY3J5cHRpb24gc3Via2V5cyBhbmQgYSByZXZva2VkIHNpZ25pbmcg
c3Via2V5IDxjb21wbGV4LWVkMjU1MTlAcnBtLm9yZz6ImgQTFgoAQhYhBHsyy8MN
NCMWJzLdhZ3W8Dmg4MHHBQJiP2F3AhsDBQkDwmcABQsJCAcCAyICAQYVCgkICwIE
FgIDAQIeBwIXgAAKCRCd1vA5oODBx1y0AQCC14V8ULAoBdQsoanET2beUJgkIdT6
LBdncZx8loRLiAD+LEWLpAGBMEq+iblPTAHjApsik02eDawLdl66Yi69Xgi4OARi
P16AEgorBgEEAZdVAQUBAQdAeHhEFfY5qU6cpSMQ/LgzayG+8Q/VBbO5X8B3R433
zi4DAQgHiLYEKBYKAF4WIQR7MsvDDTQjFicy3YWd1vA5oODBxwUCYj+JTUAdAVJl
dm9rZWQgdG8gdGVzdCBob3cgUlBNIGhhbmRsZXMgdGhlIGZpcnN0IHN1YmtleSBi
ZWluZyByZXZva2VkAAoJEJ3W8Dmg4MHHL78A/2LHlQiy8DUaH0J9XobkuEGNQYfE
e23oEZ388bqKsKDGAQDA7M0RyiM+7PskRSYTKEU36o4wqh0ePJkdcW6KQDhGBYh4
BBgWCgAgAhsMFiEEezLLww00IxYnMt2FndbwOaDgwccFAmI/iMUACgkQndbwOaDg
wcd/RwD9HAZ8Jsvwthz+f10SsZAuNSP7x89VLO7mNVu1IF96VxQBAJodLZqehAsa
HDw71wkAdLgnpPTpdQLf5MfjwKgPxC0NuDMEYj9enhYJKwYBBAHaRw8BAQdAioo3
y5vRSJzPkTtTKiex1agJT0ETOzCPTUY9BLdd+XmI7wQYFgoAIBYhBHsyy8MNNCMW
JzLdhZ3W8Dmg4MHHBQJiP16eAhsCAIEJEJ3W8Dmg4MHHdiAEGRYKAB0WIQQBtk+j
jLwMTnHv1J6p7PJc9XVyRwUCYj9engAKCRCp7PJc9XVyR3KAAQC/vEsyeWSH7Vsn
ljWv/a+nT3syIk+tpHuHFLP58yUVMwEA6HatEqVno0huk4BAZUei3EHfindIs0U7
XG9N0Mi0PguqQwD/WcaD6pZ8nvw2NzoTXdVMauSW8itL3tecYtyGZUmJfBUBAJiX
VbDIeV35E8OPf+Y5FwHWtdn2yj4G4M9BhfFOadkPuDMEYj9ethYJKwYBBAHaRw8B
AQdAw3cfxFTkAo81xCnJU0DYTLudtw7ddNBmlgqa+OW3QjmIlAQoFgoAPBYhBHsy
y8MNNCMWJzLdhZ3W8Dmg4MHHBQJiP17tHh0DVGVzdCBSUE0gcmV2b2NhdGlvbiBo
YW5kbGluZwAKCRCd1vA5oODBxxDOAQCl+gCOa4oSQKOM7VL+yoYIg/y+pf33eRH5
xB/hXfYaXQEAjLmobeeKtPZBcUMNkudpgOw/Smu37hMcqd6QMh8mqQ+I7wQYFgoA
IBYhBHsyy8MNNCMWJzLdhZ3W8Dmg4MHHBQJiP162AhsCAIEJEJ3W8Dmg4MHHdiAE
GRYKAB0WIQRO2qNgIg7sWTkLvjbb+ICPe6sQegUCYj9etgAKCRDb+ICPe6sQei5t
AP4pRYKmQvLNW9C7MUTq4Ta/2U0Ty+blDx8T3tZui5KW8wEAlgNsHN2AusrIqV1B
+2MpHhz0GuwjE/g+G5csEBaiEwYynAD/fV6NHcdOj60+LHDlOFtRhNju1QhKA6ti
uDNgH2SY8ekBAJep9gWDfWfWQDkMaJJFYU04LnSCoFdEaPgnWO2AfkQCuQGNBGI/
X2kBDACvy8pGSoYzAbVVkLq94YvvhSg28LYSg40G/SrCNBkym6QKMyOBum9tXQYk
dDArgzzUvR8G/pOZXm+Nw0pZ2IA4M61jSuoZHDXsI3P7umvq4znkCl6rp/d4XlnT
MbnC4Y9EifHzsD9DxKYnJnhvn7LnrfKnbs0bxb+0eWKhxSXeRwDFg4Hw4pQND7oc
p21jVGlFRFmGl9RdRe/GEOZSD64CrCafkaMtnUWrVHF3IM2r1Jtpr9GKULJiwTJB
ZbMIMcTuMLHzz9zDOV4zbizLT8zPAvVVPamK/RA22Y0eiSVsRffU4j3ljr0vuEeg
oBWc4aAKZByzdCHuvYzfqQru46W53xM2fTvEJxmS446S21R+n1xWZLXLLDiDF/CV
qNPP6dUgK/RV38xtYnN5e16btMAmILmQSZcQSkJPZL4Fp59L7XHnbF4XpMMLQhst
sHZ3ZUVB4r6PEqLnld+oteNjQBUmIKZ+uzafpfN9RFQDoJLuStdf4yS3fOzqNxte
zvrH1w0AEQEAAYh4BBgWCgAgFiEEezLLww00IxYnMt2FndbwOaDgwccFAmI/X2kC
GwwACgkQndbwOaDgwcex0AD+K1FEH6u0I9zfDGQ/KxydAYWzaSLDS4Mb5bp/0lbo
2iEBAM0cwefyPleuBRb1WbOIhWCW78KVxqYmbOml8UQWjhcP
=GmPE
-----END PGP PUBLIC KEY BLOCK-----

gpg(test rpm.org ed25519 key with valid signing and encryption subkeys and a revoked signing subkey <complex-ed25519@rpm.org>) = 4:9dd6f039a0e0c1c7-623f6177
gpg(a0e0c1c7) = 4:9dd6f039a0e0c1c7-623f6177
gpg(9dd6f039a0e0c1c7) = 4:9dd6f039a0e0c1c7-623f6177
gpg(f5757247) = 4:a9ecf25cf5757247-623f5e9e
gpg(a9ecf25cf5757247) = 4:a9ecf25cf5757247-623f5e9e
]],
[])
AT_CLEANUP

# -----------------------------------------
# Import a public Ed25519 key with a subkey
AT_SETUP([rpmkeys --import ed25519 with good and revoked subkeys 3])
AT_KEYWORDS([rpmkeys import])
RPMDB_INIT
AT_CHECK([
runroot rpmkeys --import /data/keys/first-signing-key-revoked.asc
runroot rpm -qi gpg-pubkey-ebddd264-623f8f42|grep -v Date|grep -v Version:
runroot rpm -q --provides gpg-pubkey
runroot rpm -e gpg-pubkey
],
[0],
[[Name        : gpg-pubkey
Version     : ebddd264
Release     : 623f8f42
Architecture: (none)
Group       : Public Keys
Size        : 0
License     : pubkey
Signature   : (none)
Source RPM  : (none)
Build Host  : localhost
Packager    : Another complex test key <test@rpm.org>
Summary     : Another complex test key <test@rpm.org> public key
Description :
-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEYj+PQhYJKwYBBAHaRw8BAQdAP4QSxJCz09EVaKH6BUHYfWrZNlworVRa0W8H
UQsp2AG0J0Fub3RoZXIgY29tcGxleCB0ZXN0IGtleSA8dGVzdEBycG0ub3JnPoia
BBMWCgBCFiEEyeRYWl0CAamgd85g0RW+m+vd0mQFAmI/j0ICGwMFCQPCZwAFCwkI
BwIDIgIBBhUKCQgLAgQWAgMBAh4HAheAAAoJENEVvpvr3dJkjjEBAMhVviHU9uTY
6Qzk4MDNCk0Okz96j+tFHd9R/dCJu6jRAP4s3WRnv3QtRqfZNZY6UsAp/n+Fv8MP
8fdQfN6la/V6CrgzBGI/j1sWCSsGAQQB2kcPAQEHQHv8VulNMB1K5gkm4lX1g5EA
6ikbpqrne6lZ9RWlcTxjiKsEKBYKAFMWIQTJ5FhaXQIBqaB3zmDRFb6b693SZAUC
Yj+PqDUdAVRlc3RpbmcgYSBjb3JuZXIgY2FzZSBpbiBSUE3igJlzIE9wZW5QR1Ag
cHJvY2Vzc2luZwAKCRDRFb6b693SZDcaAP9ObjfoUbWoAZCk5YHDRJM46iIm3Rso
7PM6YiQyZj+IsAD/Vy+GyFI6HSjseRRyv5CRYAFGrooE8zZiEKKYy36mpAWI7wQY
FgoAIBYhBMnkWFpdAgGpoHfOYNEVvpvr3dJkBQJiP49bAhsCAIEJENEVvpvr3dJk
diAEGRYKAB0WIQTOb01Xo6PinL6M2XkCZ0a0bI6plQUCYj+PWwAKCRACZ0a0bI6p
lb06AQC9L1W6jk5afsbeqsVnmUeqFZOPoIXpRv4I4Weeset2RQEA65JuqlX2Rwnx
O+Ks6i6ProtEJc9PJfurmqTkw9Husw3QmAEAy9wakg7Q/SCKaGCOEM/hk4dbvlWr
dRKzP4R71bNh5mYBAOjg0WqQhhZpe2ocrT5Q0UnGFykd4W3Uw6vYuWRSbRgAuDME
Yj+PqxYJKwYBBAHaRw8BAQdAiarMGXScnHY1b3kTHmKFEN8zZi/lCpp5rgFyYbCe
sCeI7wQYFgoAIBYhBMnkWFpdAgGpoHfOYNEVvpvr3dJkBQJiP4+rAhsCAIEJENEV
vpvr3dJkdiAEGRYKAB0WIQRXTUwdJeAh19V7FuDLLiTHrB+/PQUCYj+PqwAKCRDL
LiTHrB+/PemvAQD98K824iCRReNI9fa6tKoJIOT++2ju/LaS6Ux4NiuQ6AEAsTZW
Fz+SBgUEYUo/IG3DfYdE12QG8mosjwlSn++2iQGZCwEA75OsfeW4x8ltyduRAj5h
5nFoswUnFC2C9SpJeiZDLSgBAO5h6mRI9iafOref8xhCf6qAtnXD3J195VMX1zCU
chEM
=MpKy
-----END PGP PUBLIC KEY BLOCK-----

gpg(Another complex test key <test@rpm.org>) = 4:d115be9bebddd264-623f8f42
gpg(ebddd264) = 4:d115be9bebddd264-623f8f42
gpg(d115be9bebddd264) = 4:d115be9bebddd264-623f8f42
gpg(ac1fbf3d) = 4:cb2e24c7ac1fbf3d-623f8fab
gpg(cb2e24c7ac1fbf3d) = 4:cb2e24c7ac1fbf3d-623f8fab
]],)

AT_CLEANUP

AT_SETUP([rpmkeys --import invalid keys])
AT_KEYWORDS([rpmkeys import])
RPMDB_INIT

AT_CHECK([
runroot rpmkeys --import /data/keys/CVE-2021-3521-badbind.asc
],
[1],
[],
[error: /data/keys/CVE-2021-3521-badbind.asc: key 1 import failed.]
)
AT_CHECK([
runroot rpmkeys --import /data/keys/CVE-2021-3521-nosubsig.asc
],
[1],
[],
[error: /data/keys/CVE-2021-3521-nosubsig.asc: key 1 import failed.]
)

AT_CHECK([
runroot rpmkeys --import /data/keys/CVE-2021-3521-nosubsig-last.asc
],
[1],
[],
[error: /data/keys/CVE-2021-3521-nosubsig-last.asc: key 1 import failed.]
)
AT_CLEANUP

# ------------------------------
# Test pre-built package verification
AT_SETUP([rpmkeys -K <signed> 1])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT

runroot rpmkeys -K /data/RPMS/hello-2.0-1.x86_64-signed.rpm
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -K /data/RPMS/hello-2.0-1.x86_64-signed.rpm
],
[0],
[[/data/RPMS/hello-2.0-1.x86_64-signed.rpm: digests SIGNATURES NOT OK
/data/RPMS/hello-2.0-1.x86_64-signed.rpm: digests signatures OK
]],
[])
AT_CLEANUP

# ------------------------------
# Test pre-built package verification
AT_SETUP([rpmkeys -Kv <signed> 1])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT

runroot rpmkeys -Kv /data/RPMS/hello-2.0-1.x86_64-signed.rpm; echo $?
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub; echo $?
runroot rpmkeys -Kv /data/RPMS/hello-2.0-1.x86_64-signed.rpm; echo $?
runroot rpmkeys -Kv --nodigest /data/RPMS/hello-2.0-1.x86_64-signed.rpm; echo $?
runroot rpmkeys -Kv --nosignature /data/RPMS/hello-2.0-1.x86_64-signed.rpm; echo $?
],
[0],
[/data/RPMS/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    MD5 digest: OK
1
0
/data/RPMS/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    MD5 digest: OK
0
/data/RPMS/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
0
/data/RPMS/hello-2.0-1.x86_64-signed.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    MD5 digest: OK
0
],
[])
AT_CLEANUP

# ------------------------------
# Test pre-built corrupted package verification (corrupted signature)
AT_SETUP([rpmkeys -Kv <corrupted signed> 1])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64-signed.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=264 count=6 2> /dev/null

runroot rpmkeys -Kv /tmp/${pkg}
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header RSA signature: BAD (package tag 268: invalid OpenPGP signature)
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    MD5 digest: OK
/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header RSA signature: BAD (package tag 268: invalid OpenPGP signature)
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    MD5 digest: OK
],
[])
AT_CLEANUP
# ------------------------------
# Test pre-built corrupted package verification (corrupted header)
AT_SETUP([rpmkeys -Kv <corrupted signed> 2])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64-signed.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=5555 count=6 2> /dev/null

runroot rpmkeys -Kv /tmp/${pkg}
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    Header SHA256 digest: BAD (Expected ef920781af3bf072ae9888eec3de1c589143101dff9cc0b561468d395fb766d9 != 29fdfe92782fb0470a9a164a6c94af87d3b138c63b39d4c30e0223ca1202ba82)
    Header SHA1 digest: BAD (Expected 5cd9874c510b67b44483f9e382a1649ef7743bac != 4261b2c1eb861a4152c2239bce20bfbcaa8971ba)
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != de65519eeb4ab52eb076ec054d42e34e)
/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    Header SHA256 digest: BAD (Expected ef920781af3bf072ae9888eec3de1c589143101dff9cc0b561468d395fb766d9 != 29fdfe92782fb0470a9a164a6c94af87d3b138c63b39d4c30e0223ca1202ba82)
    Header SHA1 digest: BAD (Expected 5cd9874c510b67b44483f9e382a1649ef7743bac != 4261b2c1eb861a4152c2239bce20bfbcaa8971ba)
    Payload SHA256 digest: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != de65519eeb4ab52eb076ec054d42e34e)
],
[])
AT_CLEANUP

# ------------------------------
# Test pre-built corrupted package verification (corrupted payload)
AT_SETUP([rpmkeys -Kv <corrupted signed> 3])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64-signed.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=7777 count=6 2> /dev/null

runroot rpmkeys -Kv /tmp/${pkg}
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -Kv /tmp/${pkg}
],
[1],
[/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: BAD (Expected 84a7338287bf19715c4eed0243f5cdb447eeb0ade37b2af718d4060aefca2f7c != bea903609dceac36e1f26a983c493c98064d320fdfeb423034ed63d649b2c8dc)
    Payload SHA256 ALT digest: NOTFOUND
    V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != d662cd0d81601a7107312684ad1ddf38)
/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: BAD (Expected 84a7338287bf19715c4eed0243f5cdb447eeb0ade37b2af718d4060aefca2f7c != bea903609dceac36e1f26a983c493c98064d320fdfeb423034ed63d649b2c8dc)
    Payload SHA256 ALT digest: NOTFOUND
    V4 RSA/SHA256 Signature, key ID 1964c5fc: BAD
    DSA signature: NOTFOUND
    MD5 digest: BAD (Expected 137ca1d8b35cca02a1854ba301c5432e != d662cd0d81601a7107312684ad1ddf38)
],
[])
AT_CLEANUP

# ------------------------------
# Test pre-built corrupted package verification (corrupted payload)
AT_SETUP([rpmkeys -Kv <corrupted signed> 4])
AT_KEYWORDS([rpmkeys digest signature])
AT_CHECK([
RPMDB_INIT[(

dorpm () {
    runroot rpmkeys --define '_pkgverify_level digest' \
	--define '_pkgverify_flags 0x10000' "$1" \
	/data/RPMS/hello-2.0-1.x86_64-corrupted.rpm
    [ "$?" -eq 1 ] || exit 1
}

dorpm -K
dorpm -Kv
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
dorpm -K
dorpm -Kv
)]],
[0],
[[/data/RPMS/hello-2.0-1.x86_64-corrupted.rpm: digests SIGNATURES NOT OK
/data/RPMS/hello-2.0-1.x86_64-corrupted.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    Header SHA256 digest: OK
    MD5 digest: OK
/data/RPMS/hello-2.0-1.x86_64-corrupted.rpm: DIGESTS SIGNATURES NOT OK
/data/RPMS/hello-2.0-1.x86_64-corrupted.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    Header SHA256 digest: OK
    Payload SHA256 digest: NOTFOUND
    Payload SHA256 ALT digest: NOTFOUND
    RSA signature: NOTFOUND
    DSA signature: NOTFOUND
    MD5 digest: OK
]],
[])
AT_CLEANUP

# ------------------------------
# Test --addsign
AT_SETUP([rpmsign --addsign])
AT_KEYWORDS([rpmsign signature])
RPMDB_INIT
gpg2 --import ${RPMTEST}/data/keys/*.secret
# Our keys have no passphrases to be asked, silence GPG_TTY warning
export GPG_TTY=""

# rpmsign --addsign --rpmv3 <unsigned>
AT_CHECK([
RPMDB_INIT

cp "${RPMTEST}"/data/RPMS/hello-2.0-1.x86_64.rpm "${RPMTEST}"/tmp/
run rpmsign --key-id 1964C5FC --rpmv3 --digest-algo sha256 --addsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64.rpm > /dev/null
echo PRE-IMPORT
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
echo POST-IMPORT
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
run rpmsign --delsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64.rpm > /dev/null
echo POST-DELSIGN
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
],
[0],
[PRE-IMPORT
/tmp/hello-2.0-1.x86_64.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
POST-IMPORT
/tmp/hello-2.0-1.x86_64.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
    V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
POST-DELSIGN
/tmp/hello-2.0-1.x86_64.rpm:
],
[])

# rpmsign --addsign <unsigned>
AT_CHECK([
RPMDB_INIT

cp "${RPMTEST}"/data/RPMS/hello-2.0-1.x86_64.rpm "${RPMTEST}"/tmp/
run rpmsign --key-id 1964C5FC --digest-algo sha256 --addsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64.rpm > /dev/null
echo PRE-IMPORT
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
echo POST-IMPORT
runroot rpmkeys --import /data/keys/rpm.org-rsa-2048-test.pub
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
run rpmsign --delsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64.rpm > /dev/null
echo POST-DELSIGN
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm|grep -v digest
],
[0],
[PRE-IMPORT
/tmp/hello-2.0-1.x86_64.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
POST-IMPORT
/tmp/hello-2.0-1.x86_64.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: OK
POST-DELSIGN
/tmp/hello-2.0-1.x86_64.rpm:
],
[])

# rpmsign --addsign <signed>
AT_CHECK([
RPMDB_INIT

cp "${RPMTEST}"/data/RPMS/hello-2.0-1.x86_64-signed.rpm "${RPMTEST}"/tmp/
run rpmsign --key-id 1964C5FC --digest-algo sha256 --addsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64-signed.rpm 2>&1 |grep -q "already contains identical signature, skipping"
],
[0],
[],
[])

# rpmsign --addsign <corrupted>
AT_CHECK([
RPMDB_INIT

pkg="hello-2.0-1.x86_64.rpm"
cp "${RPMTEST}"/data/RPMS/${pkg} "${RPMTEST}"/tmp/${pkg}
dd if=/dev/zero of="${RPMTEST}"/tmp/${pkg} \
   conv=notrunc bs=1 seek=333 count=4 2> /dev/null
run rpmsign --key-id 1964C5FC --digest-algo sha256 --addsign "${RPMTEST}/tmp/${pkg}" >/dev/null 2> stderr
echo $?
grep -c "error: not signing corrupt package " stderr
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64.rpm
echo $?
],
[],
[1
1
/tmp/hello-2.0-1.x86_64.rpm:
    Header SHA256 digest: OK
    Header SHA1 digest: OK
    Payload SHA256 digest: OK
    MD5 digest: BAD (Expected 007ca1d8b35cca02a1854ba301c5432e != 137ca1d8b35cca02a1854ba301c5432e)
1
],
[])
gpgconf --kill gpg-agent
AT_CLEANUP

# ------------------------------
# Test --delsign
AT_SETUP([rpmsign --delsign])
AT_KEYWORDS([rpmsign signature])
AT_CHECK([
RPMDB_INIT

cp "${RPMTEST}"/data/RPMS/hello-2.0-1.x86_64-signed.rpm "${RPMTEST}"/tmp/
echo PRE-DELSIGN
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64-signed.rpm|grep -v digest
echo POST-DELSIGN
run rpmsign --delsign "${RPMTEST}"/tmp/hello-2.0-1.x86_64-signed.rpm > /dev/null
runroot rpmkeys -Kv /tmp/hello-2.0-1.x86_64-signed.rpm|grep -v digest
],
[0],
[PRE-DELSIGN
/tmp/hello-2.0-1.x86_64-signed.rpm:
    Header V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
    V4 RSA/SHA256 Signature, key ID 1964c5fc: NOKEY
POST-DELSIGN
/tmp/hello-2.0-1.x86_64-signed.rpm:
],
[])
AT_CLEANUP
